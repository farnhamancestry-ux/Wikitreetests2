<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WD Music Curator</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap');
        body { font-family: 'Helvetica Neue', 'Inter', sans-serif; margin: 0; padding: 0; }
        
        /* Loading animation */
        @keyframes pulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Reusable Icon component to interface with Lucide script
        const Icon = ({ name, size = 18, className = "" }) => {
            const [svg, setSvg] = useState("");
            
            useEffect(() => {
                if (window.lucide) {
                    const icon = window.lucide.icons[name];
                    if (icon) {
                        const svgString = window.lucide.createIcons({
                            icons: { [name]: icon },
                            attrs: { 
                                width: size, 
                                height: size, 
                                class: className,
                                'stroke-width': 2
                            }
                        });
                    }
                }
            }, [name, size, className]);

            // Simplified implementation using SVG paths directly or lucide-react equivalent
            // For this HTML file, we'll use standard Lucide naming mapping
            return <i data-lucide={name} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const App = () => {
            const [theme, setTheme] = useState('light');
            const [mode, setMode] = useState('song'); // 'song', 'artist', 'list'
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);
            const [status, setStatus] = useState('Ready');
            
            const [collection, setCollection] = useState(() => {
                const saved = localStorage.getItem('music_collection_curator');
                return saved ? JSON.parse(saved) : {};
            });

            useEffect(() => {
                localStorage.setItem('music_collection_curator', JSON.stringify(collection));
            }, [collection]);

            // Initialize Lucide icons after render
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });

            const toggleTheme = () => setTheme(prev => prev === 'light' ? 'dark' : 'light');

            const executeSearch = async () => {
                if (!query.trim()) return;
                setLoading(true);
                setStatus('Querying Wikidata...');
                setResults([]);

                try {
                    if (mode === 'list') {
                        await searchLists();
                    } else {
                        await searchEntities();
                    }
                } catch (e) {
                    setStatus('API Error');
                } finally {
                    setLoading(false);
                }
            };

            const searchEntities = async () => {
                const searchUrl = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(query)}&language=en&format=json&origin=*&limit=10`;
                const searchRes = await fetch(searchUrl);
                const searchData = await searchRes.json();

                if (!searchData.search || searchData.search.length === 0) {
                    setStatus('No entities found.');
                    return;
                }

                const detailedResults = [];
                for (const item of searchData.search) {
                    const details = await fetchDetails(item.id);
                    if (details) detailedResults.push(details);
                }
                setResults(detailedResults);
                setStatus(`${detailedResults.length} matches found`);
            };

            const searchLists = async () => {
                setStatus('Searching for curated lists...');
                const sparql = `
                    SELECT DISTINCT ?list ?listLabel WHERE {
                        ?list rdfs:label ?label .
                        FILTER(CONTAINS(LCASE(?label), LCASE("${query}"))) .
                        ?list wdt:P31/wdt:P279* wd:Q13406463 . 
                        SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
                    } LIMIT 10
                `;
                const url = `https://query.wikidata.org/sparql?format=json&query=${encodeURIComponent(sparql)}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.results.bindings.length === 0) {
                    setStatus('No curated lists found.');
                    return;
                }

                const listEntities = data.results.bindings.map(b => ({
                    id: b.list.value.split('/').pop(),
                    title: b.listLabel.value,
                    isList: true,
                    description: "Wikidata Curated List"
                }));
                setResults(listEntities);
                setStatus(`Found ${listEntities.length} lists`);
            };

            const fetchSongsFromList = async (listId, listTitle) => {
                setLoading(true);
                setStatus(`Fetching tracks from ${listTitle}...`);
                const sparql = `
                    SELECT DISTINCT ?song ?songLabel ?date ?performerLabel WHERE {
                        ?song wdt:P361|wdt:P2348 wd:${listId} .
                        OPTIONAL { ?song wdt:P577 ?date . }
                        OPTIONAL { ?song wdt:P175 ?performer . }
                        SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
                    } LIMIT 50
                `;
                try {
                    const url = `https://query.wikidata.org/sparql?format=json&query=${encodeURIComponent(sparql)}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    const tracks = data.results.bindings.map(b => {
                        let year = "Unknown";
                        if (b.date) {
                            const match = b.date.value.match(/\d{4}/);
                            if (match) year = match[0];
                        }
                        return {
                            id: b.song.value.split('/').pop(),
                            title: b.songLabel.value,
                            year: year,
                            artistName: b.performerLabel ? b.performerLabel.value : "Various Artists",
                            description: `From ${listTitle}`
                        };
                    });
                    setResults(tracks);
                    setStatus(`Loaded ${tracks.length} tracks from list`);
                } catch (e) {
                    setStatus('Error loading list content');
                } finally {
                    setLoading(false);
                }
            };

            const fetchDetails = async (qId) => {
                try {
                    const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${qId}&languages=en&format=json&origin=*`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const entity = data.entities[qId];
                    const claims = entity.claims || {};

                    const pubDateRaw = claims.P577?.[0]?.mainsnak?.datavalue?.value?.time;
                    let year = "Unknown";
                    if (pubDateRaw) {
                        const match = pubDateRaw.match(/\d{4}/);
                        if (match) year = match[0];
                    }

                    return {
                        id: qId,
                        title: entity.labels?.en?.value || "Unknown",
                        description: entity.descriptions?.en?.value || "",
                        year: year,
                        artistName: "" 
                    };
                } catch (e) { return null; }
            };

            const addToCollection = (item) => {
                if (item.year === "Unknown") {
                    setStatus("Cannot add: Missing release year");
                    return;
                }
                const yearList = collection[item.year] || [];
                if (yearList.length >= 10) {
                    setStatus(`Year ${item.year} is full (Max 10)`);
                    return;
                }
                if (yearList.find(i => i.id === item.id)) return;

                setCollection(prev => ({
                    ...prev,
                    [item.year]: [...yearList, item]
                }));
                setStatus(`Added to ${item.year}`);
            };

            const removeFromCollection = (year, id) => {
                setCollection(prev => ({
                    ...prev,
                    [year]: prev[year].filter(item => item.id !== id)
                }));
            };

            const exportCollection = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(collection, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "annual_index_export.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            return (
                <div className={`min-h-screen transition-colors duration-300 ${theme === 'dark' ? 'bg-[#0a0a0a] text-white' : 'bg-white text-black'}`}>
                    
                    <header className="sticky top-0 z-50 bg-inherit border-b border-current p-6 md:px-16 flex flex-col gap-4">
                        <div className="flex justify-between items-center">
                            <h1 className="text-xl font-black uppercase tracking-tighter">WD MUSIC CURATOR</h1>
                            <div className="flex gap-6 items-center">
                                <button onClick={toggleTheme} className="opacity-60 hover:opacity-100 transition-opacity">
                                    {theme === 'light' ? <i data-lucide="moon" size="18"></i> : <i data-lucide="sun" size="18"></i>}
                                </button>
                                <button onClick={exportCollection} className="text-[10px] font-bold uppercase tracking-widest opacity-60 hover:opacity-100 flex items-center gap-2">
                                    <i data-lucide="download" size="14"></i> Export
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex gap-6 overflow-x-auto no-scrollbar pb-1">
                            <button onClick={() => setMode('song')} className={`text-[10px] font-bold uppercase tracking-widest pb-1 ${mode === 'song' ? 'border-b-2 border-current' : 'opacity-40'}`}>Songs</button>
                            <button onClick={() => setMode('artist')} className={`text-[10px] font-bold uppercase tracking-widest pb-1 ${mode === 'artist' ? 'border-b-2 border-current' : 'opacity-40'}`}>Artists</button>
                            <button onClick={() => setMode('list')} className={`text-[10px] font-bold uppercase tracking-widest pb-1 ${mode === 'list' ? 'border-b-2 border-current' : 'opacity-40'}`}>Lists (RS 500 etc)</button>
                        </div>
                    </header>

                    <main className="p-6 md:p-16 grid grid-cols-1 lg:grid-cols-12 gap-12">
                        <div className="lg:col-span-7">
                            <div className="mb-12">
                                <h2 className="text-5xl md:text-8xl font-black leading-[0.85] tracking-tighter mb-8 whitespace-pre-line">
                                    {mode === 'list' ? 'SEARCH\nLISTS' : 'BUILD YOUR\nINDEX'}
                                </h2>
                                <div className="flex border-2 border-current">
                                    <input 
                                        type="text"
                                        value={query}
                                        onChange={(e) => setQuery(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && executeSearch()}
                                        placeholder={mode === 'list' ? "e.g. Rolling Stone 500..." : "Search title or artist..."}
                                        className="flex-1 bg-transparent p-5 outline-none text-xl font-bold italic"
                                    />
                                    <button onClick={executeSearch} className="bg-current px-10 flex items-center justify-center text-inherit invert">
                                        <i data-lucide="search" size="24"></i>
                                    </button>
                                </div>
                                <p className="mt-4 text-[10px] uppercase tracking-[0.2em] font-black opacity-40">{status}</p>
                            </div>

                            <div className="grid gap-px bg-current/10 border border-current/10">
                                {results.map(item => (
                                    <div key={item.id} className={`${theme === 'dark' ? 'bg-[#0a0a0a]' : 'bg-white'} p-8 flex justify-between items-center group hover:bg-zinc-50 dark:hover:bg-zinc-900 transition-colors`}>
                                        <div className="flex-1">
                                            <div className="flex items-center gap-3 mb-1">
                                                <span className="text-[10px] font-mono text-blue-500 font-bold tracking-widest">{item.id}</span>
                                                {item.year && <span className="text-[10px] font-black uppercase tracking-widest px-2 py-0.5 border border-current/20">{item.year}</span>}
                                            </div>
                                            <h3 className="text-2xl font-black tracking-tighter leading-tight uppercase">{item.title}</h3>
                                            <p className="text-xs opacity-50 mt-1 uppercase font-bold tracking-widest">{item.artistName || item.description}</p>
                                        </div>
                                        
                                        {item.isList ? (
                                            <button onClick={() => fetchSongsFromList(item.id, item.title)} className="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest bg-blue-600 text-white py-3 px-6 hover:bg-blue-700 transition-colors">
                                                Explore List <i data-lucide="arrow-right" size="14"></i>
                                            </button>
                                        ) : (
                                            <button onClick={() => addToCollection(item)} className="opacity-0 group-hover:opacity-100 flex items-center gap-2 text-[10px] font-black uppercase tracking-widest bg-current text-inherit invert py-3 px-6 transition-all">
                                                <i data-lucide="plus" size="14"></i> Add
                                            </button>
                                        )}
                                    </div>
                                ))}
                                {loading && <div className="p-20 text-center animate-pulse text-[10px] uppercase font-black tracking-[0.3em] opacity-20">Accessing Wikidata Hub...</div>}
                            </div>
                        </div>

                        <div className="lg:col-span-5 border-l border-current/10 pl-0 lg:pl-12">
                            <div className="sticky top-44">
                                <h2 className="text-[10px] font-black uppercase tracking-[0.3em] mb-10 opacity-30 flex items-center justify-between">
                                    THE ANNUAL INDEX
                                    <span>{Object.values(collection).flat().length} TRACKS</span>
                                </h2>
                                
                                <div className="space-y-8 max-h-[65vh] overflow-y-auto pr-4 no-scrollbar">
                                    {Object.keys(collection).sort((a,b) => b-a).map(year => (
                                        <div key={year} className="group">
                                            <div className="flex justify-between items-end border-b-2 border-current pb-2 mb-4">
                                                <h4 className="text-4xl font-black italic leading-none">{year}</h4>
                                                <span className="text-[10px] font-black opacity-30 tracking-widest">{collection[year].length}/10</span>
                                            </div>
                                            <div className="space-y-3">
                                                {collection[year].map(song => (
                                                    <div key={song.id} className="flex justify-between items-start text-xs group/item">
                                                        <div className="flex flex-col">
                                                            <span className="font-black uppercase tracking-tight text-sm">{song.title}</span>
                                                            <span className="opacity-40 uppercase text-[9px] font-bold tracking-widest">{song.artistName}</span>
                                                        </div>
                                                        <button onClick={() => removeFromCollection(year, song.id)} className="opacity-0 group-hover/item:opacity-100 text-red-500 hover:scale-110 transition-all">
                                                            <i data-lucide="trash-2" size="14"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                    {Object.keys(collection).length === 0 && (
                                        <div className="py-24 text-center border-4 border-dotted border-current/10">
                                            <p className="text-[10px] uppercase font-black tracking-[0.4em] opacity-20">Index Pending</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </main>

                    <footer className="p-16 border-t border-current flex flex-col md:flex-row justify-between items-center gap-12 mt-20">
                        <div className="max-w-xs">
                            <p className="text-[10px] font-black uppercase tracking-[0.2em] mb-2">Wikidata Protocol</p>
                            <p className="text-xs opacity-50">Direct integration with the global linked data network for music preservation and metadata extraction.</p>
                        </div>
                        <div className="flex gap-16">
                            <div className="flex flex-col gap-2">
                                <span className="text-[10px] uppercase opacity-30 font-black tracking-widest">Linked Props</span>
                                <span className="text-xs font-black">P175 Performer</span>
                                <span className="text-xs font-black">P577 Pub Date</span>
                                <span className="text-xs font-black">P2348 List Part</span>
                            </div>
                            <div className="flex flex-col gap-2">
                                <span className="text-[10px] uppercase opacity-30 font-black tracking-widest">Storage</span>
                                <span className="text-xs font-black">Browser LocalStorage</span>
                                <span className="text-xs font-black">JSON Export Ready</span>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>