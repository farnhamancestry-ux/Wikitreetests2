<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiTree Toolbox | Unified Research Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-btn.active { background-color: #15803d; color: white; transform: translateX(4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .glass { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); }
        .form-input { @apply w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none transition-all text-sm; }
        .output-box { @apply p-4 bg-slate-900 text-green-400 rounded-xl font-mono text-xs leading-relaxed break-words border border-slate-800 shadow-inner; }
        .btn-primary { @apply py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition-all active:scale-[0.98] disabled:opacity-50; }
        .btn-secondary { @apply py-3 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-xl shadow-lg transition-all active:scale-[0.98]; }
    </style>
</head>
<body class="min-h-screen text-slate-800 antialiased">

    <div class="max-w-7xl mx-auto px-4 py-6 md:py-10">
        <!-- Header & API Key -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-6 bg-white p-6 rounded-3xl shadow-sm border border-white">
            <div class="flex items-center gap-4">
                <div class="bg-green-600 p-3 rounded-2xl text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight leading-none">WikiTree <span class="text-green-600">Toolbox</span></h1>
                    <p class="text-slate-500 text-sm mt-1 font-medium italic">Your unified researcher's assistant</p>
                </div>
            </div>
            
            <div class="w-full md:w-80 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                <label class="text-[10px] font-bold uppercase tracking-widest text-slate-400 block mb-1">Gemini API Key (Local Storage)</label>
                <input type="password" id="apiKeyInput" placeholder="Paste key for Smart Bio..." 
                    class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs focus:ring-2 focus:ring-green-500 outline-none">
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sidebar Navigation -->
            <nav class="w-full lg:w-72 shrink-0 space-y-2" id="navContainer">
                <button onclick="switchTab('ai')" class="nav-btn active w-full text-left px-5 py-4 rounded-2xl font-bold flex items-center gap-4 transition-all hover:bg-white hover:shadow-sm">
                    <span>‚ú®</span> Smart AI Bio
                </button>
                <button onclick="switchTab('wikipedia')" class="nav-btn w-full text-left px-5 py-4 rounded-2xl font-bold flex items-center gap-4 transition-all hover:bg-white hover:shadow-sm">
                    <span>üåê</span> Wikidata & Wikipedia
                </button>
                <button onclick="switchTab('gro')" class="nav-btn w-full text-left px-5 py-4 rounded-2xl font-bold flex items-center gap-4 transition-all hover:bg-white hover:shadow-sm">
                    <span>üá¨üáß</span> GRO Ref Gen
                </button>
                <button onclick="switchTab('citation')" class="nav-btn w-full text-left px-5 py-4 rounded-2xl font-bold flex items-center gap-4 transition-all hover:bg-white hover:shadow-sm">
                    <span>üìé</span> Multi-Source Citation
                </button>
                <button onclick="switchTab('sentence')" class="nav-btn w-full text-left px-5 py-4 rounded-2xl font-bold flex items-center gap-4 transition-all hover:bg-white hover:shadow-sm">
                    <span>‚úçÔ∏è</span> Sentence Maker
                </button>
            </nav>

            <!-- Main Panel -->
            <main class="flex-1 glass border border-white rounded-[2.5rem] shadow-2xl p-6 md:p-8 min-h-[600px]">
                
                <!-- Tab: AI Smart Bio -->
                <section id="ai" class="tab-content active space-y-6">
                    <h2 class="text-2xl font-extrabold text-slate-900 border-b border-slate-100 pb-4 flex items-center gap-2">
                        Smart AI Biography Section
                    </h2>
                    <p class="text-sm text-slate-500">Paste any records (Census, GRO, FreeBMD, Wills) and I will write the Bio and Sources sections.</p>
                    <textarea id="aiInput" class="w-full h-64 p-5 border border-slate-200 rounded-2xl bg-slate-50 font-mono text-sm leading-relaxed outline-none focus:ring-2 focus:ring-green-500" placeholder="Paste data here..."></textarea>
                    <button onclick="generateAIBio()" id="aiBtn" class="w-full btn-primary flex items-center justify-center gap-2">
                        Draft WikiTree Sections
                    </button>
                    <div id="aiOutputContainer" class="hidden space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Output</span>
                            <button onclick="copyToClipboard('aiOutput')" class="text-xs font-bold bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl">Copy Text</button>
                        </div>
                        <div id="aiOutput" class="output-box bg-slate-900 text-slate-200 font-mono text-sm leading-relaxed whitespace-pre-wrap"></div>
                    </div>
                </section>

                <!-- Tab: Wikidata Search & Notability -->
                <section id="wikipedia" class="tab-content space-y-6">
                    <h2 class="text-2xl font-extrabold text-slate-900 border-b border-slate-100 pb-4">Wikidata Search & Notability</h2>
                    
                    <div class="space-y-4">
                        <div class="relative">
                            <input type="text" id="wikiSearchInput" placeholder="Start typing a name (e.g. John Lennon)..." 
                                class="w-full px-6 py-4 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none text-lg font-medium shadow-sm">
                            <div id="searchLoader" class="absolute right-6 top-5 hidden animate-spin">‚è≥</div>
                        </div>

                        <!-- Search Results -->
                        <div id="wikiSearchResults" class="space-y-2 max-h-80 overflow-y-auto hidden"></div>

                        <!-- Entity Detail Display -->
                        <div id="wikiDetailBox" class="hidden p-6 bg-blue-50 border border-blue-100 rounded-3xl space-y-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 id="wikiDetailLabel" class="text-2xl font-black text-slate-900"></h3>
                                    <p id="wikiDetailDesc" class="text-slate-500 font-medium"></p>
                                    <p id="wikiDetailId" class="text-blue-600 font-mono text-xs mt-1"></p>
                                </div>
                                <button onclick="resetWikiSearch()" class="text-xs font-bold text-slate-400 hover:text-slate-600 uppercase tracking-widest">Clear</button>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase">WikiTree Templates</label>
                                    <div class="output-box bg-slate-800" id="wikiTemplateOutput"></div>
                                    <button onclick="copyToClipboard('wikiTemplateOutput')" class="w-full py-2 bg-slate-700 text-white text-xs font-bold rounded-lg mt-1">Copy Templates</button>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-black text-slate-400 uppercase">Notability Statement</label>
                                    <div class="output-box bg-slate-800 italic" id="wikiBioOutput">Generating...</div>
                                    <button onclick="copyToClipboard('wikiBioOutput')" class="w-full py-2 bg-slate-700 text-white text-xs font-bold rounded-lg mt-1">Copy Bio Statement</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tab: GRO Reference Generator -->
                <section id="gro" class="tab-content space-y-6">
                    <h2 class="text-2xl font-extrabold text-slate-900 border-b border-slate-100 pb-4">GRO Reference Generator</h2>
                    
                    <div class="p-5 bg-green-50 rounded-2xl border border-green-100">
                        <label class="text-[10px] font-black text-green-700 mb-2 block uppercase">Quick Parse (Paste GRO Index row here)</label>
                        <div class="flex gap-2">
                            <input type="text" id="groQuickInput" placeholder="e.g. WOMBWELL, MARTHA CHESHAM GRO Reference: 1885..." class="flex-1 px-4 py-3 border-2 border-green-200 rounded-xl outline-none focus:border-green-500">
                            <button onclick="parseGRO()" class="px-6 py-3 bg-green-600 text-white font-bold rounded-xl shadow-lg shadow-green-200">Parse</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <input type="text" id="groS" placeholder="Surname" class="form-input">
                        <input type="text" id="groF" placeholder="First Name(s)" class="form-input">
                        <input type="text" id="groM" placeholder="Mother's Surname" class="form-input">
                        <input type="text" id="groY" placeholder="Year" class="form-input">
                        <select id="groQ" class="form-input">
                            <option value="March">March (Q1)</option><option value="June">June (Q2)</option><option value="September">September (Q3)</option><option value="December">December (Q4)</option>
                        </select>
                        <input type="text" id="groD" placeholder="District" class="form-input">
                        <input type="text" id="groV" placeholder="Volume" class="form-input">
                        <input type="text" id="groP" placeholder="Page" class="form-input">
                    </div>
                    <button onclick="generateGRO()" class="w-full btn-secondary">Build Reference</button>
                    <div id="groOutputBox" class="output-box hidden"><div id="groOutput"></div></div>
                </section>

                <!-- Tab: Multi-Source Citation -->
                <section id="citation" class="tab-content space-y-6">
                    <h2 class="text-2xl font-extrabold text-slate-900 border-b border-slate-100 pb-4">Multi-Source Citation Builder</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-4">
                            <input type="text" id="citeTitle" placeholder="Citation Title (e.g. 1881 Census)" class="form-input">
                            <input type="text" id="citeDb" placeholder="Database/Repository" class="form-input">
                            <input type="text" id="citeUrl" placeholder="Record URL" class="form-input">
                            <input type="text" id="citeSharing" placeholder="Ancestry Sharing Link (Auto-formats to template)" class="form-input">
                        </div>
                        <div class="space-y-4">
                            <textarea id="citeTrans" class="form-input h-[100px]" placeholder="Transcription/Notes..."></textarea>
                            <div class="flex gap-2">
                                <input type="date" id="citeDate" class="form-input">
                                <button onclick="generateManualCitation()" class="px-6 py-2 bg-slate-800 text-white font-bold rounded-xl">Generate</button>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-orange-50 border border-orange-100 rounded-2xl">
                        <label class="text-[10px] font-black text-orange-700 uppercase block mb-2">FreeBMD / NSW Raw Parse</label>
                        <textarea id="rawCiteInput" class="form-input h-24" placeholder="Paste FreeBMD row or NSW result text..."></textarea>
                        <div class="flex gap-2 mt-2">
                            <button onclick="parseFreeBMD()" class="flex-1 py-2 bg-orange-200 text-orange-800 font-bold rounded-lg text-xs">Parse FreeBMD</button>
                            <button onclick="parseNSW()" class="flex-1 py-2 bg-orange-200 text-orange-800 font-bold rounded-lg text-xs">Parse NSW BDM</button>
                        </div>
                    </div>

                    <div id="citeOutputBox" class="output-box hidden"><div id="citeOutput"></div></div>
                </section>

                <!-- Tab: Sentence Maker -->
                <section id="sentence" class="tab-content space-y-6">
                    <h2 class="text-2xl font-extrabold text-slate-900 border-b border-slate-100 pb-4">Sentence Maker</h2>
                    <textarea id="sentenceInput" class="w-full h-40 p-4 border border-slate-200 rounded-2xl bg-slate-50 font-mono text-xs" placeholder="Paste tab-separated data here..."></textarea>
                    <button onclick="generateSentence()" class="w-full btn-secondary">Generate Bio Sentence</button>
                    <div id="sentenceOutput" class="p-6 bg-blue-50 border-l-4 border-blue-500 rounded-2xl italic font-medium hidden"></div>
                </section>

            </main>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 px-6 py-3 bg-slate-900 text-white font-bold rounded-2xl shadow-2xl translate-y-20 opacity-0 transition-all duration-300 z-50"></div>

    <script>
        // API Management
        const apiKeyInput = document.getElementById('apiKeyInput');
        apiKeyInput.value = localStorage.getItem('wt_gemini_key') || '';
        apiKeyInput.addEventListener('input', (e) => localStorage.setItem('wt_gemini_key', e.target.value));

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 2500);
        }

        function copyToClipboard(id) {
            const text = document.getElementById(id).innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast('Copied to Clipboard!');
        }

        // --- WIKIDATA SEARCH LOGIC ---
        let searchTimeout;
        const wikiSearchInput = document.getElementById('wikiSearchInput');
        const wikiSearchResults = document.getElementById('wikiSearchResults');
        const searchLoader = document.getElementById('searchLoader');

        wikiSearchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            if (query.length < 3) {
                wikiSearchResults.classList.add('hidden');
                return;
            }
            searchTimeout = setTimeout(() => searchWikidata(query), 500);
        });

        async function searchWikidata(query) {
            searchLoader.classList.remove('hidden');
            try {
                const url = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(query)}&language=en&format=json&origin=*&limit=8`;
                const response = await fetch(url);
                const data = await response.json();
                
                wikiSearchResults.innerHTML = '';
                if (data.search && data.search.length > 0) {
                    data.search.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "p-4 bg-white border border-slate-100 rounded-xl cursor-pointer hover:border-blue-500 hover:shadow-md transition-all";
                        div.innerHTML = `
                            <div class="font-bold text-slate-900">${item.label}</div>
                            <div class="text-xs text-slate-500 italic">${item.description || 'No description'}</div>
                            <div class="text-[10px] text-blue-600 font-mono mt-1">${item.id}</div>
                        `;
                        div.onclick = () => selectWikiEntity(item.id, item.label, item.description);
                        wikiSearchResults.appendChild(div);
                    });
                    wikiSearchResults.classList.remove('hidden');
                } else {
                    wikiSearchResults.innerHTML = '<div class="p-4 text-slate-400 text-sm">No results found.</div>';
                }
            } catch (err) { console.error(err); }
            finally { searchLoader.classList.add('hidden'); }
        }

        async function selectWikiEntity(id, label, desc) {
            wikiSearchResults.classList.add('hidden');
            wikiSearchInput.value = label;
            
            document.getElementById('wikiDetailLabel').innerText = label;
            document.getElementById('wikiDetailDesc').innerText = desc || "No description provided.";
            document.getElementById('wikiDetailId').innerText = id;
            document.getElementById('wikiDetailBox').classList.remove('hidden');
            
            // Templates
            document.getElementById('wikiTemplateOutput').innerText = `{{Wikidata|${id}}}\n{{Wikipedia}}`;
            
            // Fetch Notability Statement
            fetchNotability(id, label);
        }

        async function fetchNotability(id, title) {
            const bioOut = document.getElementById('wikiBioOutput');
            bioOut.innerText = "Querying Wikidata properties...";
            
            try {
                const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${id}&languages=en&format=json&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                const entity = data.entities[id];

                let statement = `${title} was documented as a ${entity.descriptions?.en?.value || 'notable individual'}.`;
                
                // Get Occupations (P106)
                if (entity.claims?.P106) {
                    const occIds = entity.claims.P106.slice(0, 3).map(c => c.mainsnak.datavalue.value.id);
                    const names = await fetchLabels(occIds);
                    if (names.length > 0) {
                        statement = `${title} was a ${names.join(', ')}.`;
                    }
                }

                // Get Awards (P166)
                if (entity.claims?.P166) {
                    const awardIds = entity.claims.P166.slice(0, 2).map(c => c.mainsnak.datavalue.value.id);
                    const names = await fetchLabels(awardIds);
                    if (names.length > 0) {
                        statement += ` They received recognitions including the ${names.join(' and ')}.`;
                    }
                }

                bioOut.innerText = statement;
            } catch (err) {
                bioOut.innerText = `${title} is a notable person on Wikidata (ID: ${id}).`;
            }
        }

        async function fetchLabels(ids) {
            try {
                const url = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${ids.join('|')}&props=labels&languages=en&format=json&origin=*`;
                const response = await fetch(url);
                const data = await response.json();
                return ids.map(id => data.entities[id]?.labels?.en?.value).filter(v => !!v);
            } catch { return []; }
        }

        function resetWikiSearch() {
            document.getElementById('wikiDetailBox').classList.add('active');
            wikiSearchInput.value = '';
            document.getElementById('wikiDetailBox').classList.add('hidden');
        }

        // --- GRO PARSER LOGIC ---
        function parseGRO() {
            const raw = document.getElementById('groQuickInput').value.trim();
            const re = /([A-Z\s\-']+),\s+([A-Z\s\-']+)\s+([A-Z\s\-']+)?\s+GRO Reference:\s+(\d{4})\s+([A-Z])\s+Quarter in\s+([A-Z\s\-']+)\s+Volume\s+([0-9A-Z]+)\s+Page\s+(\d+)/i;
            const match = raw.match(re);
            if (match) {
                document.getElementById('groS').value = match[1].trim();
                document.getElementById('groF').value = match[2].trim();
                document.getElementById('groM').value = match[3] ? match[3].trim() : '';
                document.getElementById('groY').value = match[4];
                const qMap = { 'M': 'March', 'J': 'June', 'S': 'September', 'D': 'December' };
                document.getElementById('groQ').value = qMap[match[5].toUpperCase()];
                document.getElementById('groD').value = match[6].trim();
                document.getElementById('groV').value = match[7];
                document.getElementById('groP').value = match[8];
                showToast('Fields Populated!');
            }
        }

        function generateGRO() {
            const s = document.getElementById('groS').value.toUpperCase();
            const f = document.getElementById('groF').value.toUpperCase();
            const m = document.getElementById('groM').value.toUpperCase() || 'NONE';
            const y = document.getElementById('groY').value;
            const q = document.getElementById('groQ').value;
            const d = document.getElementById('groD').value.toUpperCase();
            const v = document.getElementById('groV').value;
            const p = document.getElementById('groP').value;

            const ref = `<ref>'''Birth Registration''': "England & Wales General Register Office", GRO Online Indexes - Birth (accessed ${new Date().toLocaleDateString('en-GB', {day:'numeric', month:'long', year:'numeric'})}), ${s}, ${f} (Mother's maiden name: ${m}). GRO Reference: ${y} ${q.charAt(0)} Quarter in ${d} Volume ${v} Page ${p}.</ref>`;
            document.getElementById('groOutput').textContent = ref;
            document.getElementById('groOutputBox').classList.remove('hidden');
        }

        // --- CITATION LOGIC ---
        function generateManualCitation() {
            const title = document.getElementById('citeTitle').value;
            const db = document.getElementById('citeDb').value;
            const url = document.getElementById('citeUrl').value;
            const sharing = document.getElementById('citeSharing').value;
            const trans = document.getElementById('citeTrans').value;
            const access = document.getElementById('citeDate').value;

            let formattedSharing = '';
            if (sharing.includes('sharing/')) {
                const parts = sharing.split('/');
                const id = parts[parts.length - 2];
                const token = parts[parts.length - 1].split('?')[0];
                formattedSharing = `\n{{Ancestry Sharing|${id}|${token}}}`;
            }

            const ref = `<ref>\n'''${title}''': "${db}", ${url} (accessed ${access})${formattedSharing}${trans ? '\n\n' + trans : ''}\n</ref>`;
            document.getElementById('citeOutput').textContent = ref;
            document.getElementById('citeOutputBox').classList.remove('hidden');
        }

        function parseFreeBMD() {
            const raw = document.getElementById('rawCiteInput').value;
            // Simplified demonstration parser for FreeBMD rows
            if (raw.includes('District')) {
                document.getElementById('citeTitle').value = "Marriage Index";
                document.getElementById('citeDb').value = "FreeBMD Index";
                document.getElementById('citeUrl').value = "https://www.freebmd.org.uk";
                document.getElementById('citeTrans').value = "Extracted: " + raw.replace(/\t/g, ' ');
                generateManualCitation();
            }
        }

        function parseNSW() {
            const raw = document.getElementById('rawCiteInput').value;
            document.getElementById('citeTitle').value = "NSW BDM Registration";
            document.getElementById('citeDb').value = "NSW Registry of Births Deaths and Marriages";
            document.getElementById('citeUrl').value = "https://familyhistory.bdm.nsw.gov.au";
            document.getElementById('citeTrans').value = raw;
            generateManualCitation();
        }

        // --- SENTENCE MAKER LOGIC ---
        function generateSentence() {
            const input = document.getElementById('sentenceInput').value;
            const data = {};
            input.split('\n').forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 2) data[parts[0].trim().toLowerCase()] = parts[1].trim();
            });
            const name = data['name'] || 'The subject';
            const age = data['age'] || data['age in 1911'] || '?';
            const res = data['street address'] || '';
            let sentence = `${name} (age ${age}) was born in ${data['birth place'] || 'unknown'}.`;
            if (res) sentence += ` They resided at ${res}.`;
            const out = document.getElementById('sentenceOutput');
            out.innerText = sentence;
            out.classList.remove('hidden');
        }

        // --- AI SMART BIO ---
        async function generateAIBio() {
            const key = localStorage.getItem('wt_gemini_key');
            const input = document.getElementById('aiInput').value;
            const btn = document.getElementById('aiBtn');
            if (!key) return showToast('Please enter API Key');
            
            btn.disabled = true;
            btn.innerText = 'Drafting Bio...';
            
            const systemPrompt = `You are a WikiTree fact compiler, you format profiles.
            1. Use only the sources provided to write the bio. The sources provided will already be in the preferred format. You are just ordering them and using them to write simple concise sentences for the bio.
2. Strictly do not duplicate the sources provided.
            3. Ensure the bio has == Biography == and
== Sources == with
<references /> underneath
            4. Optionally but sparingly add
=== Early Life ===
=== Family ===
=== Occupation ===
=== Death & Legacy ===
== Research Notes ==

            5. Use only WikiTree markup
6. Do not create or unnecessarily rename sources provided. You are just writing sentences from sources provided.
7. Do not name citations. Only use <ref> citation </ref> and ensure these are not below <references />  
8. Do not duplicate inline citations. A citation can support a number of sentence facts.
9. Ensure for every citation a sentence is written.
10. If there are sources under <references/> move them above ==Sources== enclose them with inline <ref> </ref> tags and remove the * 
            Output ONLY the raw WikiTree markup.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: input }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    document.getElementById('aiOutput').innerText = text;
                    document.getElementById('aiOutputContainer').classList.remove('hidden');
                }
            } catch (err) { showToast('API Error'); }
            finally { btn.disabled = false; btn.innerText = 'Draft WikiTree Sections'; }
        }

        document.getElementById('citeDate').valueAsDate = new Date();
    </script>
</body>
</html>